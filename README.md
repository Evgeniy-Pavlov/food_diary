# food_diary

### О сервисе

food_diary это django приложение, предоставляющее API для ведения статистики пользователя по учету калорий, баланса белков/жиров/углеводов (далее БЖУ) и рациону.
Приложение позволяет получать статистику за день и за определенный период по балансу БЖУ и рациону.
Для запуска приложения необходимо его сначала клонировать на свою машину командой `git clone https://github.com/Evgeniy-Pavlov/food_diary.git`.

### Условия запуска
Для запуска приложения необходим Docker. [Ссылка](https://docs.docker.com/get-docker/?_gl=1*1of64ty*_ga*MzUwNzU1OTYyLjE3MDc5NDMxMDI.*_ga_XJWPQMJYHQ*MTcwODU4NDQwMC40LjEuMTcwODU4NDQ3NS40OS4wLjA.) для скачивания Docker.

После установки Docker необходимо выполнить команду в терминале `docker-compose up` (прим. у вас должна быть открыта директория с проектом, в ином случае при наличии docker-compose файлов будут запущены они, а не нужный вам).

При успешном старте приложения в терминале вы увидите следующее для контейнера django.
`System check identified no issues (0 silenced).
February 22, 2024 - 06:52:03
Django version 4.2.9, using settings 'mainapp.settings'
Starting development server at http://[::]:8000/
Quit the server with CONTROL-C.`

После успешно старта необходимо выполнить миграции БД. Выполните команду в терминале `docker-compose run django python manage.py migrate`.

Рекомендуется создать администратора. Это делается командой `docker-compose run django python manage.py createsuperuser`. Появится поля ввода в терминале, в которых необходимо заполнить логин, почту, пароль и подтвердить пароль. После ввести `y`, после чего учетная запись администратора будет успешно создана.

### API
В рамках проекта используется авторизация по JWT. 
Swagger доступен по ссылке в формате <ALLOWED_HOSTS:port/swagger>.

##### Авторизация и регистрация, смена пароля, выход из системы

###### Авторизация
Для выполнения большинства запросов (почти все кроме регистрации и авторизации), потребуется наличия заголовка запроса `Authorization`, в качестве значения должно быть указано `Bearer {access token}`. 
Получить access токен можно авторизовавшись методом POST `api/auth/`. В качестве аргумента принимается `username`(string) и `password`(string) (имя пользователя и пароль соответственно). Возвращает acsess и refresh токены.

###### Регистрация
Регистрация осуществляется методом POST `api/register/`. В качестве значений в теле запроса передаются `username`(string), `email`(string), `password`(string). Все указанные значения являются обязательными. В результате регистрации возвращает 201 код при успешном создании и `username` и `email` в теле ответа.

###### Смена пароля
Смена пароля осуществляется методом PUT `api/change-pwd/{user.id}`, где user.id это id записи пользователя из таблицы UserBase. Для выполнения запроса необходимо быть авторизованным (в запросе обязательно наличие заголовка `Authorization`). Принимает в теле запроса `username`(string), `old_password`(string), `new_password`(string), все поля являются обязательными. Как следует из названия полей необходимо указать `username` - имя пользователя, `old_password` - текущий пароль пользователя, `new_password` - новый пароль на который хотим сменить. В случае успеха возвращает 200 код, в теле ответа `{'success': 'Password change'}`, в случае неудачи (если логин или пароль неверные) возвращает 400 код и в теле ответа `{"error": "Form is not valid"}`.

###### Выход из системы
Выход из системы осуществляется методом POST `api/logout`. Принимает в качестве аргумента `refresh` (string), и заносит данный токен в черный список (признает недействительным).
В качестве успеха возвращает 201 код.

ВАЖНО! Наличие заголовка `Authorization` далее применимо ко всем запросам описанным ниже.

##### Food

###### Создание блюд в справочнике DirectoryFood
Создание блюд в справочнике блюд происходит методом POST `api/food/add`. Принимает в теле запроса обязательно `name` (string) и необязательно `caloric`(integer), `fat`(integer), `carbon`(integer), `protein`(integer), `user_create`(integer). В результате создания возвращает 201 код и в теле запроса запись со всеми вышеописанными полями.

###### Удаление еды из справочника DirectoryFood
Метод DELETE `api/food/delete/{food.id}` принимает в path 1 аргумент, это id блюда из справочника DirectoryFood. В результате успешного выполнения получаем 204 код.

###### Создание рецепта
Рецепт блюда создается методом POST `api/food/recipe/create`. ВАЖНО! Создание блюда в справочнике блюд, не означает, что у блюда есть рецепт, т.к. описание блюда (т.е. его рецепта) не является обязательным полем при создании методом `api/food/add`. При создании принимает следующее в теле запроса:
`user`(integer) - имя пользователя, является обязательным
`food`(string) - название блюда, является обязательным
`description`(string) - рецепт блюда, необязательно
`ingredients` - список словарей, необязателен
    `ingredient`(string) - название ингредиента, необязательно (ожидаем, что введенные ингредиенты существуют в справочнике ингредиентов)
    `gram`(integer) - граммовки ингредиентов, необязательно

В результате выполнения возвращает 201 код при успешном создании и возвращает в теле введенные ранее данные.

###### Удаление рецепта.
Метод DELETE `api/food/recipe/{food.id}` принимает в path 1 аргумент, это id блюда из справочника DirectoryFood, являющегося рецептом. В результате успешного выполнения получаем 204 код.

###### Получение рецепта
Получить рецепт можно методом GET `api/food/get-recipe`, принимает 2 query-параметра:
`name`(string) - название рецепта, обязательно
`pdf_file`(boolean) - параметр для получения рецепта в формате pdf, необязательно

В случае успеха возвращает 200 код и рецепт в теле ответа в json (если `pdf_file`!=true) или pdf_file (если `pdf_file`=true).

###### Добавление ингредиента в справочник DirectoryIngredients
Добавление ингредиента происходит методом POST `api/food/ingredients/add`. Принимаетв теле запроса обязательно `name` (string) и необязательно `caloric`(integer), `fat`(integer), `carbon`(integer), `protein`(integer), `user_create`(integer). В результате успешного выполнения возвращает 201 код и отправленные данные в теле ответа.

###### Удаление ингредиента из справочника DirectoryIngredients
Удаление происходит методом DELETE `api/food/ingredients/delete/{ingredient.id}. Принимает в path в качестве аргумента только id ингредиента из справочника DirectoryIngredients.
В случае успешного удаления возвращает 204 код.

###### Поиск блюд
Поиск блюд осуществляется методом GET `api/food/search`. Принимает в качестве query-параметров два значения:
`name`(string) - название блюда, обязательно
`lang`(string) - сокращенное название языка на котором будет поиск (ru, en, fr и т.д), обязательно
В случае успеха возвращает 200 код и в теле ответа список блюд соответствующих результатам поиска, с информацией о названии, калорийности и БЖУ.

##### User

###### Добавление статистики о рационе пользователя
Метод POST `api/user/foodstat/add` добавляет запись о блюде которое съел пользователь. 
В теле запроса принимается несколько аргументов:
`user`(integer) - id пользователя которому добавляем запись, обязательно
`food`(integer) - id блюда которое добавляем в статистику, обязательно
`date`(string) - дата в формате гггг-мм-дд, по умолчанию устанавливается текущая дата, необязательно
В результате успешного запроса возвращает 201 код и отправленные данные в теле ответа. 
ВАЖНО! По бизнесу предполагается использовавание именно этого метода, т.к. вместе с добавлением блюда в список, будет происходить добавление статистики еще и в UserStat.

###### Удаление статистики о рационе пользователя
Метод DELETE `api/user/foodstat/delete/{foodstat.id}` удаляет запись о блюде пользователя. Принимает в path id записи в таблице UserFoodDay. В случае успешного удаления возвращает 204 код.

###### Получение статистики о блюдах пользователя за день
Метод GET `api/user/foodstat/day` принимает в качестве в качестве обязательных query-параметров дату в формате гггг-мм-дд `date`(string) и id пользователя `user`(integer).
В результате возвращает список блюд пользователя.

###### Получение статистики о блюдах пользователя за период
Метод GET `api/user/foodstat/period` принимает в качестве в качестве обязательных query-параметров дату начала поиска в формате гггг-мм-дд `date_start`(string), `date_end` (string) дату окочания поиска в формате гггг-мм-дд, id пользователя `user`(integer). Необязательными параметрами являются `pdf_file`(boolean) и `csv_file`(boolean). 
В случае если `pdf_file`!= true и `csv_file`!=true, то результат будет возвращен в формате json.
В случае если `pdf_file`=true то результат будет представлен в pdf в виде таблицы.
В случае если `csv_file`=true, то результат будет представлен в csv.

###### Добавление статистики пользователя по БЖУ и калориям
Добавление статистики пользователя по калориям и БЖУ осуществляется методом POST `api/user/userstat/add`. В теле запроса принимает следующее аргументы:
`user`(integer) - id пользователя которому добавляем запись, обязательно
`calories_burned`(integer) - количество калорий добавляемое к статистике, обязательно
`protein_burned`(integer) - количество протеина добавляемое к статистике, обязательно
`fat_burned`(integer) - количество жиров добавляемое к статистике, обязательно
`carbon_burned`(integer) - количество углеводов добавляемое к статистике, обязательно
`date`(string) - дата на которую добавляем статистику. необязательно (по умолчанию текущая дата)

###### Получение статистики по БЖУ и калориям пользователя за день
Метод GET `api/user/stat-for-day` принимает в качестве в качестве обязательных query-параметров дату в формате гггг-мм-дд `date`(string) и id пользователя `user`(integer).
В результате успешного получения статистики возвращает запись за указанный день с количеством калорий пользователя и БЖУ.

###### Получение статистики по БЖУ и калориям пользователя за период 
Метод GET `api/user/stat-for-period` принимает в качестве в качестве обязательных query-параметров дату начала поиска в формате гггг-мм-дд `date_start`(string), `date_end` (string) дату окочания поиска в формате гггг-мм-дд, id пользователя `user`(integer). Необязательными параметрами являются `pdf_file`(boolean) и `csv_file`(boolean). 
В случае если `pdf_file`!= true и `csv_file`!=true, то результат будет возвращен в формате json.
В случае если `pdf_file`=true то результат будет представлен в pdf в виде таблицы.
В случае если `csv_file`=true, то результат будет представлен в csv.

###### Получение информации о пользователе из UserBase
Метод GET `user/userinfo` принимает в качестве обязательного query-параметра только значение username. В случае успеха возвращает 200 код и в теле ответа id пользователя, его username и email.
